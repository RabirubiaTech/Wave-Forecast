name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests

      - name: Generate Wave Forecast Card
        run: |
          python3 << 'EOF'
          import requests, textwrap, re
          from PIL import Image, ImageDraw, ImageFont
          import io, os, traceback

          USER_AGENT = "RabirubiaWeather (contact@rabirubiaweather.example)"  # adjust email if you want

          def get_forecast_text():
              fallback = "Marine forecast temporarily unavailable. Please refer directly to NWS Marine Weather."
              try:
                  headers = {"User-Agent": USER_AGENT}

                  # 1) Get latest Marine (MIM) product for SJU
                  r_list = requests.get(
                      "https://api.weather.gov/products/types/MIM/locations/SJU",
                      headers=headers,
                      timeout=20,
                  )
                  r_list.raise_for_status()
                  plist = r_list.json()
                  products = plist.get("products") or []
                  if not products:
                      return fallback

                  pid = products[0].get("id")
                  if not pid:
                      return fallback

                  # 2) Get the product text
                  r_prod = requests.get(
                      f"https://api.weather.gov/products/{pid}",
                      headers=headers,
                      timeout=20,
                  )
                  r_prod.raise_for_status()
                  prod = r_prod.json()
                  text = prod.get("productText")
                  if not text or not isinstance(text, str):
                      return fallback

                  # 3) Sanitize: remove control chars, normalize spaces
                  text = text.replace("\r", "")
                  text = re.sub(r"[\x00-\x1F\x7F]", " ", text)
                  text = re.sub(r"\s+", " ", text).strip()
                  if not text:
                      return fallback

                  # 4) Remove leading header-ish chunk (first ~300 chars or until first blank line)
                  # NOAA products often have headers; this trims them without depending on exact lines.
                  if len(text) > 300:
                      text = text[300:]

                  # 5) Limit length so card stays readable
                  text = text[:1200]

                  # 6) Wrap for the card
                  wrapped = textwrap.fill(text, width=42)
                  return wrapped or fallback
              except Exception as e:
                  print("Forecast error:", e)
                  traceback.print_exc()
                  return fallback

          def get_background():
              try:
                  bg_url = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e"
                  data = requests.get(bg_url, timeout=20).content
                  img = Image.open(io.BytesIO(data)).convert("RGB")
              except Exception as e:
                  print("Background error:", e)
                  img = Image.new("RGB", (800, 800), "#004488")
              return img.resize((800, 800))

          def get_logo():
              try:
                  logo_url = (
                      "https://static.wixstatic.com/media/"
                      "80c250_b1146919dfe046429a96648c59e2c413~mv2.png/"
                      "v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,"
                      "enc_avif,quality_auto/RWRoundLogoTransp.png"
                  )
                  data = requests.get(logo_url, timeout=20).content
                  logo = Image.open(io.BytesIO(data)).convert("RGBA")
              except Exception as e:
                  print("Logo error:", e)
                  logo = Image.new("RGBA", (120, 120), "white")
              return logo.resize((120, 120))

          def create_card():
              forecast_text = get_forecast_text()
              bg = get_background()

              # Dark overlay
              overlay = Image.new("RGBA", bg.size, (0, 0, 0, 120))
              base = Image.alpha_composite(bg.convert("RGBA"), overlay)
              draw = ImageDraw.Draw(base)

              logo = get_logo()
              base.paste(logo, (40, 40), logo)

              # Fonts
              try:
                  font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 48)
                  font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
                  font_body = ImageFont.truetype("DejaVuSans.ttf", 26)
                  font_footer = ImageFont.truetype("DejaVuSans.ttf", 22)
              except Exception:
                  font_title = font_sub = font_body = font_footer = ImageFont.load_default()

              # Header
              draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
              draw.text((400, 180), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
              draw.text((400, 240), "Puerto Rico & USVI", fill="white", font=font_sub, anchor="mm")

              # Forecast body text (left-aligned block)
              draw.multiline_text(
                  (80, 300),
                  forecast_text,
                  fill="white",
                  font=font_body,
                  align="left",
                  spacing=8,
              )

              # Footer
              draw.text(
                  (400, 760),
                  "NOAA Marine Forecast | RabirubiaWeather",
                  fill="#a0e4ff",
                  font=font_footer,
                  anchor="mm",
              )

              base.convert("RGB").save("wave_card.png", optimize=True)
              print("Saved wave_card.png")

          if __name__ == "__main__":
              try:
                  create_card()
              except Exception as e:
                  # Absolute fallback: still create a card so the workflow never breaks
                  print("FATAL ERROR, creating fallback card:", e)
                  traceback.print_exc()
                  img = Image.new("RGB", (800, 800), "#004488")
                  d = ImageDraw.Draw(img)
                  msg = "RabirubiaWeather\nWave Forecast\nError generating card.\nCheck NWS Marine directly."
                  d.multiline_text((400, 400), msg, fill="white", font=ImageFont.load_default(),
                                   anchor="mm", align="center")
                  img.save("wave_card.png", optimize=True)
                  print("Saved fallback wave_card.png")
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f wave_card.png ]; then
            echo "ERROR: wave_card.png not found â€” aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
