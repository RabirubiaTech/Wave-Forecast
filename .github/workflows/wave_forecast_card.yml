name: Wave Forecast Card Generator

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  generate-wave-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests pillow numpy matplotlib

      - name: Fetch 7‑Day Wave Forecast (PR + USVI)
        run: |
          python3 << 'EOF'
          import requests, json

          url = "https://api.weather.gov/gridpoints/SJU/103,45/forecast"
          headers = {"User-Agent": "RabirubiaWeather"}

          try:
              data = requests.get(url, headers=headers, timeout=20).json()
          except Exception as e:
              data = {"error": str(e)}

          with open("wave_data.json", "w") as f:
              json.dump(data, f, indent=2)
          EOF

      - name: Generate Wave Forecast Image Card
        run: |
          python3 << 'EOF'
          import json, random, os
          from PIL import Image, ImageDraw, ImageFont

          with open("wave_data.json") as f:
              data = json.load(f)

          periods = []
          try:
              periods = data["properties"]["periods"][:14]
          except:
              periods = []

          days = {}
          for p in periods:
              name = p["name"].split()[0]
              if name not in days:
                  days[name] = p["detailedForecast"]

          if not days:
              days = {"Forecast": "Wave data unavailable at this time."}

          backgrounds = [
              "assets/marine_bg1.jpg",
              "assets/marine_bg2.jpg",
              "assets/marine_bg3.jpg",
              "assets/marine_bg4.jpg",
              "assets/marine_bg5.jpg"
          ]

          bg_path = next((b for b in backgrounds if os.path.exists(b)), None)

          if not bg_path:
              bg = Image.new("RGB", (1080, 1350), (0, 70, 140))
          else:
              bg = Image.open(bg_path).convert("RGB")

          bg = bg.resize((1080, 1350))
          draw = ImageDraw.Draw(bg)

          try:
              font_header = ImageFont.truetype("arial.ttf", 70)
              font_sub = ImageFont.truetype("arial.ttf", 40)
              font_body = ImageFont.truetype("arial.ttf", 32)
              font_disclaimer = ImageFont.truetype("arial.ttf", 24)
          except:
              font_header = font_sub = font_body = font_disclaimer = ImageFont.load_default()

          brand_blue = (0, 102, 204)
          brand_gold = (255, 204, 0)
          white = (255, 255, 255)

          draw.rectangle([(0, 0), (1080, 180)], fill=brand_blue)
          draw.text((40, 40), "RabirubiaWeather", fill=white, font=font_header)
          draw.text((40, 130), "7‑Day Wave Forecast • PR & USVI", fill=brand_gold, font=font_sub)

          y = 240
          for day, forecast in days.items():
              draw.text((50, y), f"{day}: {forecast}", fill=white, font=font_body)
              y += 120

          disclaimer = (
              "Maps and information intended for informational purposes only! "
              "For Emergency situations and/or decisions, please refer to your "
              "local Emergency Management Office and/or the National Weather Service."
          )

          draw.text((40, 1250), disclaimer, fill=white, font=font_disclaimer)

          os.makedirs("generated", exist_ok=True)
          bg.save("generated/wave_forecast_card.png", optimize=True)
          EOF

      - name: Commit to generated branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout -B generated

          git add generated/wave_forecast_card.png
          git commit -m "Auto-update wave forecast card" || echo "No changes"

          git push -u origin generated
