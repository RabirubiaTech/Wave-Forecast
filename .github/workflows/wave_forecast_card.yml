name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ImageMagick and jq
        run: sudo apt-get update && sudo apt-get install -y imagemagick jq

      - name: Download logo
        run: |
          curl -L -o logo.png "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png"

      - name: Download marine background (safe)
        run: |
          BG_LIST=(
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e"
            "https://images.unsplash.com/photo-1500375592092-40eb2168fd21"
            "https://images.unsplash.com/photo-1501959915551-4e8a04a3f9a6"
            "https://images.unsplash.com/photo-1493558103817-58b2924bce98"
          )
          URL=${BG_LIST[$RANDOM % ${#BG_LIST[@]}]}
          curl -L "$URL" -o background.jpg

          # Validate background
          if [ ! -s background.jpg ]; then
            echo "Background download failed, using fallback"
            convert -size 800x800 xc:"#004488" background.jpg
          fi

      - name: Fetch NOAA Marine Forecast and prepare text
        run: |
          DATA=$(curl -s "https://api.weather.gov/gridpoints/SJU/103,45/forecast")

          # Extract 7 periods safely
          PERIODS=$(echo "$DATA" | jq -r '.properties.periods[0:7][]? | "\(.name): \(.detailedForecast)"')

          # Fallback if NOAA fails
          if [ -z "$PERIODS" ]; then
            echo "Forecast unavailable at this time." > forecast.txt
          else
            echo "$PERIODS" | fold -s -w 40 > forecast.txt
          fi

          # Validate forecast
          if [ ! -s forecast.txt ]; then
            echo "Forecast unavailable" > forecast.txt
          fi

      - name: Generate Wave Forecast Card
        run: |
          # Validate logo
          if [ ! -s logo.png ]; then
            echo "Logo missing â€” creating placeholder"
            convert -size 120x120 xc:white logo.png
          fi

          # Generate card
          convert background.jpg -resize 800x800^ -gravity center -crop 800x800+0+0 +repage \
            -fill 'rgba(0,0,0,0.35)' -draw "rectangle 0,0 800,800" \
            \( logo.png -resize 120x120 \) -gravity NorthWest -geometry +40+40 -composite \
            -fill white -font DejaVu-Sans-Bold -pointsize 48 -gravity NorthWest -annotate +170+70 "RabirubiaWeather" \
            -fill white -pointsize 60 -gravity center -annotate +0-200 "Wave Forecast" \
            -fill white -pointsize 40 -gravity center -annotate +0-120 "Puerto Rico & USVI" \
            -fill white -font DejaVu-Sans -pointsize 28 -gravity center -annotate +0+40 "@forecast.txt" \
            -fill '#a0e4ff' -pointsize 22 -gravity South -annotate +0+20 "NOAA Marine Forecast | RabirubiaWeather" \
            wave_card.png

      - name: Commit and push updated image
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
