name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests beautifulsoup4

      - name: Generate Wave Forecast Card
        run: |
          python3 << 'EOF'
          import requests, re
          from bs4 import BeautifulSoup
          from PIL import Image, ImageDraw, ImageFont, ImageEnhance
          import io
          from datetime import datetime

          URL = "https://www.ndbc.noaa.gov/data/Forecasts/FZCA52.TJSJ.html"
          ZONE = "AMZ712"
          FALLBACK = "Wave forecast temporarily unavailable."

          # ---------------------------------------------------------
          # FETCH + PARSE HTML
          # ---------------------------------------------------------
          try:
              r = requests.get(URL, timeout=20)
              r.raise_for_status()
              html = r.text
          except:
              html = None

          if not html:
              forecast_text = FALLBACK
          else:
              soup = BeautifulSoup(html, "html.parser")
              text = soup.get_text("\n")

              pattern = rf"({ZONE}.*?)(AMZ\\d{{3}}|$)"
              m = re.search(pattern, text, re.DOTALL)
              if not m:
                  forecast_text = FALLBACK
              else:
                  block = m.group(1).replace("feet", "ft")

                  lines = block.splitlines()
                  periods = []
                  current_label = None
                  current_text = []

                  for line in lines:
                      line = line.strip()
                      if re.match(r"^(REST OF TONIGHT|TODAY|MON|TUE|WED|THU|FRI|SAT|SUN)", line):
                          if current_label and current_text:
                              periods.append((current_label, " ".join(current_text)))
                          current_label = line
                          current_text = []
                      else:
                          if current_label:
                              current_text.append(line)

                  if current_label and current_text:
                      periods.append((current_label, " ".join(current_text)))

                  cleaned = []
                  for label, txt in periods:
                      if label == "REST OF TONIGHT":
                          label = "TODAY"
                      cleaned.append((label, txt))

                  cleaned = cleaned[:6]

                  final_lines = []
                  first_line = True

                  for label, txt in cleaned:

                      # ⭐ FORCE FIRST LINE TO "Currently"
                      if first_line:
                          label = "Currently"
                          first_line = False

                      m = re.search(
                          r"Wave Detail:\s*([A-Za-z]+)\s*(\d+)\s*ft\s*at\s*(\d+)\s*seconds?",
                          txt,
                          re.I
                      )
                      if not m:
                          continue

                      direction = m.group(1).upper()
                      height = int(m.group(2))
                      period = m.group(3)

                      low = height - 1
                      high = height + 1
                      height_str = f"{low}–{high} ft"

                      final_lines.append(f"{label}: {height_str} @ {period}s {direction}")

                  forecast_text = "\n".join(final_lines) if final_lines else FALLBACK

          # ---------------------------------------------------------
          # BACKGROUND
          # ---------------------------------------------------------
          try:
              bg_data = requests.get(
                  "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
                  timeout=20
              ).content
              bg = Image.open(io.BytesIO(bg_data)).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          enhancer = ImageEnhance.Brightness(bg)
          bg = enhancer.enhance(1.12)

          overlay = Image.new("RGBA", bg.size, (255, 255, 255, 40))
          card = Image.alpha_composite(bg.convert("RGBA"), overlay)

          draw = ImageDraw.Draw(card)

          # ---------------------------------------------------------
          # LOGO
          # ---------------------------------------------------------
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))

          # ---------------------------------------------------------
          # FONTS
          # ---------------------------------------------------------
          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 36)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 28)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 18)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          TEXT = "#0a1a2f"

          # ---------------------------------------------------------
          # DATE FOR HEADER
          # ---------------------------------------------------------
          today_str = datetime.now().strftime("%b %d, %Y")

          # ---------------------------------------------------------
          # DRAW CARD
          # ---------------------------------------------------------
          card.paste(logo, (40, 40), logo)

          draw.text((200, 80), today_str, fill=TEXT, font=font_title)

          draw.text((400, 180), "Wave Forecast", fill=TEXT, font=font_sub, anchor="mm")
          draw.text((400, 240), "North Puerto Rico (AMZ712)", fill=TEXT, font=font_sub, anchor="mm")

          draw.multiline_text(
              (80, 300),
              forecast_text,
              fill=TEXT,
              font=font_body,
              align="left",
              spacing=10
          )

          # ---------------------------------------------------------
          # SINGLE-LINE FOOTER
          # ---------------------------------------------------------
          footer_line = "NDBC Marine Forecast | RabirubiaWeather.com | Updated every 6 hours"

          draw.text(
              (400, 730),
              footer_line,
              fill=TEXT,
              font=font_footer,
              anchor="mm"
          )

          card.convert("RGB").save("wave_card.png", optimize=True)
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f wave_card.png ]; then
            echo "ERROR: wave_card.png not found — aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
