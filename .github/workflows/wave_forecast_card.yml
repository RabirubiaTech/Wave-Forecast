- name: Generate Wave Forecast Card
        run: |
          python3 << 'EOF'
          import requests, textwrap, re
          from PIL import Image, ImageDraw, ImageFont
          import io, os, traceback

          HEADERS = {
              "User-Agent": "RabirubiaWeather (contact@rabirubiaweather.com)",
              "Accept": "application/geo+json, application/json"
          }

          def get_forecast_text():
              fallback = "Marine forecast temporarily unavailable. Please refer directly to NWS Marine Weather."

              try:
                  # 1) Get latest Marine (MIM) product for SJU
                  r_list = requests.get(
                      "https://api.weather.gov/products/types/MIM/locations/SJU",
                      headers=HEADERS,
                      timeout=20
                  )
                  r_list.raise_for_status()

                  plist = r_list.json()
                  products = plist.get("products") or []
                  if not products:
                      return fallback

                  pid = products[0].get("id")
                  if not pid:
                      return fallback

                  # 2) Get the product text
                  r_prod = requests.get(
                      f"https://api.weather.gov/products/{pid}",
                      headers=HEADERS,
                      timeout=20
                  )
                  r_prod.raise_for_status()

                  prod = r_prod.json()
                  raw_text = prod.get("productText", "")
                  if not raw_text:
                      return fallback

                  # 3) Sanitize
                  text = raw_text.replace("\r", "")
                  text = re.sub(r"[\x00-\x1F\x7F]", " ", text)
                  text = re.sub(r"\s+", " ", text).strip()

                  # 4) Remove header block (NOAA metadata)
                  # Find first marine zone header like "AMZ7"
                  m = re.search(r"(AMZ\d{3}.*?)$", text)
                  if m:
                      text = m.group(1)

                  # 5) Limit length
                  text = text[:1500]

                  # 6) Wrap
                  wrapped = textwrap.fill(text, width=42)
                  return wrapped or fallback

              except Exception as e:
                  print("Forecast error:", e)
                  traceback.print_exc()
                  return fallback

          # === The rest of the script stays the same ===

          forecast_text = get_forecast_text()

          # Background
          try:
              bg_data = requests.get(
                  "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
                  timeout=20
              ).content
              bg = Image.open(io.BytesIO(bg_data)).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          # Logo
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png/v1/fill/w_234,h_234,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/RWRoundLogoTransp.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))

          # Overlay
          overlay = Image.new("RGBA", bg.size, (0, 0, 0, 120))
          bg = Image.alpha_composite(bg.convert("RGBA"), overlay)
          draw = ImageDraw.Draw(bg)

          # Fonts
          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 48)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 26)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 22)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          # Header
          draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
          draw.text((400, 180), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
          draw.text((400, 240), "Puerto Rico & USVI", fill="white", font=font_sub, anchor="mm")

          # Forecast text
          draw.multiline_text(
              (80, 300),
              forecast_text,
              fill="white",
              font=font_body,
              align="left",
              spacing=8
          )

          # Footer
          draw.text(
              (400, 760),
              "NOAA Marine Forecast | RabirubiaWeather",
              fill="#a0e4ff",
              font=font_footer,
              anchor="mm"
          )

          bg.convert("RGB").save("wave_card.png", optimize=True)
          print("Saved wave_card.png")
          EOF
