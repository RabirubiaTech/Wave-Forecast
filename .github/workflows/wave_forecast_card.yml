name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests

      - name: Generate Wave Forecast Card
        run: |
          python3 << 'EOF'
          import requests, textwrap, re, io, traceback, os
          from PIL import Image, ImageDraw, ImageFont

          HEADERS = {
              "User-Agent": "RabirubiaWeather (contact@rabirubiaweather.com)",
              "Accept": "application/geo+json, application/json"
          }

          FALLBACK = (
              "Marine forecast temporarily unavailable.\n"
              "Please refer directly to NWS Marine Weather."
          )

          FONT_BOLD = "/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf"
          FONT_REG = "/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf"

          def safe_json(resp):
              try:
                  return resp.json()
              except:
                  return None

          def get_forecast_text():
              try:
                  r = requests.get(
                      "https://api.weather.gov/products/types/CWF/locations/SJU",
                      headers=HEADERS,
                      timeout=20
                  )
                  data = safe_json(r)
                  if not data or not data.get("products"):
                      return FALLBACK

                  pid = data["products"][0]["id"]

                  r2 = requests.get(
                      f"https://api.weather.gov/products/{pid}",
                      headers=HEADERS,
                      timeout=20
                  )
                  prod = safe_json(r2)
                  raw = prod.get("productText", "")

                  if not raw:
                      return FALLBACK

                  text = raw.replace("\r", "")
                  text = re.sub(r"[^\x20-\x7E\n]", " ", text)
                  text = re.sub(r"\n{3,}", "\n\n", text).strip()

                  if "\n\n" in text:
                      text = text.split("\n\n", 1)[1]

                  text = text[:1400]

                  return "\n".join(
                      textwrap.fill(line, width=42)
                      for line in text.splitlines()
                      if line.strip()
                  )

              except Exception as e:
                  print("Forecast error:", e)
                  traceback.print_exc()
                  return FALLBACK

          forecast_text = get_forecast_text()

          try:
              bg = Image.open(io.BytesIO(
                  requests.get(
                      "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
                      timeout=20
                  ).content
              )).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          try:
              logo = Image.open(io.BytesIO(
                  requests.get(
                      "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                      timeout=20
                  ).content
              )).convert("RGBA").resize((120, 120))
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          card = Image.alpha_composite(
              bg.convert("RGBA"),
              Image.new("RGBA", bg.size, (0, 0, 0, 120))
          )

          draw = ImageDraw.Draw(card)

          font_title = ImageFont.truetype(FONT_BOLD, 48)
          font_sub = ImageFont.truetype(FONT_REG, 40)
          font_body = ImageFont.truetype(FONT_REG, 26)
          font_footer = ImageFont.truetype(FONT_REG, 22)

          card.paste(logo, (40, 40), logo)
          draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
          draw.text((400, 180), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
          draw.text((400, 240), "Puerto Rico & USVI", fill="white", font=font_sub, anchor="mm")

          draw.multiline_text(
              (80, 300),
              forecast_text,
              fill="white",
              font=font_body,
              spacing=8
          )

          draw.text(
              (400, 760),
              "NOAA Marine Forecast | RabirubiaWeather",
              fill="#a0e4ff",
              font=font_footer,
              anchor="mm"
          )

          card.convert("RGB").save("wave_card.png", format="PNG")
          print("wave_card.png generated:", os.path.exists("wave_card.png"))
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f wave_card.png ]; then
            echo "ERROR: wave_card.png not found â€” aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
