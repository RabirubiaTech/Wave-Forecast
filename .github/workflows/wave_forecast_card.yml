name: Update Wave Forecast Card Image

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests beautifulsoup4

      - name: Generate Wave Forecast Card (with debug)
        run: |
          python3 << 'EOF'
          import requests, re, textwrap
          from PIL import Image, ImageDraw, ImageFont
          import io, traceback

          URL = "https://www.ndbc.noaa.gov/data/Forecasts/FZCA52.TJSJ.html"
          ZONE = "AMZ712"
          FALLBACK = "Wave forecast temporarily unavailable."

          print("\n===== FETCHING NDBC FORECAST =====")

          def fetch_ndbc():
              try:
                  r = requests.get(URL, timeout=20)
                  r.raise_for_status()
                  print("NDBC fetch OK\n")
                  return r.text
              except Exception as e:
                  print("NDBC fetch error:", e)
                  traceback.print_exc()
                  return None

          def extract_zone_block(text):
              print("===== EXTRACTING ZONE BLOCK =====")
              pattern = rf"({ZONE}.*?)(AMZ\\d{{3}}|$)"
              m = re.search(pattern, text, re.DOTALL | re.IGNORECASE)
              if not m:
                  print("ZONE NOT FOUND")
                  return None
              block = m.group(1)
              print(block)
              print("===== END ZONE BLOCK =====\n")
              return block

          def extract_daytime_periods(block):
              print("===== SPLITTING INTO DAYTIME PERIODS =====")
              day_labels = ["TODAY", "MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"]

              periods = []
              lines = block.splitlines()

              current_label = None
              current_text = []

              for line in lines:
                  line = line.strip()

                  if any(line.startswith(lbl) for lbl in day_labels):
                      if current_label and current_text:
                          periods.append((current_label, " ".join(current_text)))
                      current_label = line.split()[0]
                      current_text = []
                  else:
                      if current_label:
                          current_text.append(line)

              if current_label and current_text:
                  periods.append((current_label, " ".join(current_text)))

              print("Extracted periods:")
              for p in periods:
                  print(p[0], "=>", p[1])
              print("===== END PERIOD SPLIT =====\n")

              return periods[:6]

          def extract_wave_info(text):
              print("Parsing wave info from:", text)

              t = text.lower()

              # 1. Range: "4 to 6 ft"
              m_range = re.search(r"seas? (\d+)\s*(?:to|-)\s*(\d+)\s*ft", t)
              if m_range:
                  low, high = m_range.group(1), m_range.group(2)
                  height = f"{low}–{high} ft"
              else:
                  # 2. Single: "5 ft" or "around 5 ft"
                  m_single = re.search(r"seas? (?:around )?(\d+)\s*ft", t)
                  if m_single:
                      val = int(m_single.group(1))
                      height = f"{val-1}–{val+1} ft"
                  else:
                      print("NO WAVE HEIGHT FOUND\n")
                      return None

              # 3. Period
              m_period = re.search(r"(\d+)\s*(?:sec|seconds)", t)
              seconds = m_period.group(1) if m_period else ""

              # 4. Direction
              m_dir = re.search(
                  r"\b(n|ne|ene|nne|e|ese|se|sse|s|ssw|sw|wsw|w|wnw|nw|nnw)\b",
                  t
              )
              direction = m_dir.group(1).upper() if m_dir else ""

              result = f"{height} @ {seconds}s {direction}".strip()
              print("Parsed:", result, "\n")
              return result

          def build_forecast():
              raw = fetch_ndbc()
              if not raw:
                  return FALLBACK

              block = extract_zone_block(raw)
              if not block:
                  return FALLBACK

              periods = extract_daytime_periods(block)
              if not periods:
                  return FALLBACK

              print("===== BUILDING ULTRA-COMPACT FORECAST =====")
              lines = []
              for label, text in periods:
                  wave = extract_wave_info(text)
                  if wave:
                      lines.append(f"{label}: {wave}")

              if not lines:
                  print("NO WAVE DATA FOUND — USING FALLBACK\n")
                  return FALLBACK

              final = "\n".join(lines)
              print("FINAL FORECAST:\n", final)
              print("===== END FORECAST BUILD =====\n")
              return final

          forecast_text = build_forecast()

          # ---------------------------------------------------------
          # BACKGROUND IMAGE
          # ---------------------------------------------------------
          try:
              bg_data = requests.get(
                  "https://images.unsplash.com/photo-1507525428034-b723cf961d3e",
                  timeout=20
              ).content
              bg = Image.open(io.BytesIO(bg_data)).convert("RGB")
          except:
              bg = Image.new("RGB", (800, 800), "#004488")

          bg = bg.resize((800, 800))

          # ---------------------------------------------------------
          # LOGO
          # ---------------------------------------------------------
          try:
              logo_data = requests.get(
                  "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                  timeout=20
              ).content
              logo = Image.open(io.BytesIO(logo_data)).convert("RGBA")
          except:
              logo = Image.new("RGBA", (120, 120), "white")

          logo = logo.resize((120, 120))

          # ---------------------------------------------------------
          # DRAW CARD
          # ---------------------------------------------------------
          overlay = Image.new("RGBA", bg.size, (0, 0, 0, 120))
          card = Image.alpha_composite(bg.convert("RGBA"), overlay)
          draw = ImageDraw.Draw(card)

          try:
              font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 48)
              font_sub = ImageFont.truetype("DejaVuSans.ttf", 40)
              font_body = ImageFont.truetype("DejaVuSans.ttf", 28)
              font_footer = ImageFont.truetype("DejaVuSans.ttf", 22)
          except:
              font_title = font_sub = font_body = font_footer = ImageFont.load_default()

          card.paste(logo, (40, 40), logo)
          draw.text((170, 60), "RabirubiaWeather", fill="white", font=font_title)
          draw.text((400, 180), "Wave Forecast", fill="white", font=font_sub, anchor="mm")
          draw.text((400, 240), "North Puerto Rico (AMZ712)", fill="white", font=font_sub, anchor="mm")

          draw.multiline_text(
              (80, 300),
              forecast_text,
              fill="white",
              font=font_body,
              align="left",
              spacing=10
          )

          draw.text(
              (400, 760),
              "NDBC Marine Forecast | RabirubiaWeather",
              fill="#a0e4ff",
              font=font_footer,
              anchor="mm"
          )

          card.convert("RGB").save("wave_card.png", optimize=True)
          print("Saved wave_card.png")
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f wave_card.png ]; then
            echo "ERROR: wave_card.png not found — aborting commit"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add wave_card.png
          git commit -m "Auto-update wave forecast card image" || echo "No changes to commit"
          git push
